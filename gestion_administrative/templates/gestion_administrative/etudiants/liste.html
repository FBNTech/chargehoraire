{% extends 'base.html' %}

{% block content %}
{% csrf_token %}
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="card-title mb-0">Gestion des Étudiants</h2>
            <div class="d-flex gap-2">
              <a href="{% url 'gestion_administrative:liste_absences_etudiants' %}" class="btn btn-info">
                <i class="fas fa-list"></i> Liste des absences
              </a>
              <a href="{% url 'gestion_administrative:autorisation_absence_etudiant' %}" class="btn btn-warning">
                <i class="fas fa-file-alt"></i> Autorisation d'absence
              </a>
              <a href="{% url 'gestion_administrative:importer_etudiants_excel' %}" class="btn btn-success">
                <i class="fas fa-file-excel"></i> Importer Excel
              </a>
              <a href="{% url 'gestion_administrative:ajouter_etudiant' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Ajouter un étudiant
              </a>
            </div>
          </div>

          <!-- Filtres et recherche -->
          <div class="row mb-3">
            <div class="col-md-8">
              <form method="GET" class="d-flex">
                <input type="text" name="search" class="form-control me-2" 
                       placeholder="Rechercher par matricule, nom ou classe..." 
                       value="{{ search }}">
                <button type="submit" class="btn btn-outline-primary">
                  <i class="fas fa-search"></i>
                </button>
              </form>
            </div>
            <div class="col-md-4">
              <form method="GET">
                {% if search %}<input type="hidden" name="search" value="{{ search }}">{% endif %}
                <select name="statut" class="form-select" onchange="this.form.submit()">
                  <option value="">Tous les statuts</option>
                  <option value="actif" {% if statut_filter == 'actif' %}selected{% endif %}>Actif</option>
                  <option value="inactif" {% if statut_filter == 'inactif' %}selected{% endif %}>Inactif</option>
                  <option value="diplome" {% if statut_filter == 'diplome' %}selected{% endif %}>Diplômé</option>
                  <option value="abandonne" {% if statut_filter == 'abandonne' %}selected{% endif %}>Abandonné</option>
                </select>
              </form>
            </div>
          </div>

          {% if etudiants %}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Matricule</th>
                  <th>Nom complet</th>
                  <th>Département</th>
                  <th>Classe</th>
                  <th>Téléphone</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for etudiant in etudiants %}
                <tr>
                  <td><strong>{{ etudiant.matricule }}</strong></td>
                  <td>{{ etudiant.nom_complet }}</td>
                  <td>{{ etudiant.departement|default:"-" }}</td>
                  <td>{{ etudiant.classe|default:"-" }}</td>
                  <td>{{ etudiant.telephone|default:"-" }}</td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <button type="button" class="btn btn-outline-primary" title="Voir détails" 
                              data-bs-toggle="modal" data-bs-target="#detailModal{{ etudiant.id }}">
                        <i class="fas fa-eye"></i>
                      </button>
                      <a href="{% url 'gestion_administrative:modifier_etudiant' etudiant.id %}" 
                         class="btn btn-outline-warning" title="Modifier">
                        <i class="fas fa-edit"></i>
                      </a>
                      <button type="button" class="btn btn-outline-danger" title="Supprimer"
                              onclick="deleteEtudiant({{ etudiant.id }}, '{{ etudiant.nom_complet|escapejs }}')">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>

                <!-- Modal détails pour chaque étudiant -->
                <div class="modal fade" id="detailModal{{ etudiant.id }}" tabindex="-1">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Détails de l'étudiant</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <div class="row g-3">
                          <div class="col-md-6"><strong>Matricule:</strong> {{ etudiant.matricule }}</div>
                          <div class="col-md-6"><strong>Nom complet:</strong> {{ etudiant.nom_complet }}</div>
                          <div class="col-md-6"><strong>Date de naissance:</strong> {{ etudiant.date_naissance|date:"d/m/Y"|default:"-" }}</div>
                          <div class="col-md-6"><strong>Sexe:</strong> {{ etudiant.get_sexe_display|default:"-" }}</div>
                          <div class="col-md-6"><strong>Téléphone:</strong> {{ etudiant.telephone|default:"-" }}</div>
                          <div class="col-md-6"><strong>Département:</strong> {{ etudiant.departement|default:"-" }}</div>
                          <div class="col-md-6"><strong>Classe:</strong> {{ etudiant.classe|default:"-" }}</div>
                          <div class="col-md-6"><strong>Année académique:</strong> {{ etudiant.annee_academique|default:"-" }}</div>
                          <div class="col-12"><strong>Créé le:</strong> {{ etudiant.created_at|date:"d/m/Y à H:i" }}</div>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="alert alert-info text-center">
            <h5>Aucun étudiant trouvé</h5>
            <p class="mb-0">Commencez par ajouter des étudiants ou importer un fichier Excel.</p>
          </div>
          {% endif %}

          <div class="mt-3">
            <a href="{% url 'gestion_administrative:dashboard' %}" class="btn btn-secondary">
              Retour au tableau de bord
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function deleteEtudiant(id, nomComplet) {
  if (confirm('Êtes-vous sûr de vouloir supprimer l\'étudiant ' + nomComplet + ' ?')) {
    fetch(`/gestion/etudiants/supprimer/${id}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert(data.message);
        location.reload();
      } else {
        alert('Erreur lors de la suppression');
      }
    })
    .catch(error => {
      console.error('Erreur:', error);
      alert('Erreur lors de la suppression');
    });
  }
}
</script>
{% endblock %}
