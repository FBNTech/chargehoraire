{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h2 class="card-title text-center mb-4">Gestion des Publications des Enseignants</h2>
          
          <!-- Statistiques -->
          <div class="row mb-4">
            <div class="col-md-4">
              <div class="card bg-primary text-white">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h5 class="card-title">Total publications</h5>
                      <p class="display-4">{{ total_publications }}</p>
                    </div>
                    <i class="fas fa-book-open fa-3x"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="card bg-info text-white">
                <div class="card-body">
                  <div class="text-center">
                    <h5 class="card-title">Articles</h5>
                    <p class="display-4">{{ total_articles }}</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="card bg-success text-white">
                <div class="card-body">
                  <div class="text-center">
                    <h5 class="card-title">Livres</h5>
                    <p class="display-4">{{ total_livres }}</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="card bg-danger text-white">
                <div class="card-body">
                  <div class="text-center">
                    <h5 class="card-title">Thèses</h5>
                    <p class="display-4">{{ total_theses }}</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="card bg-warning text-white">
                <div class="card-body">
                  <div class="text-center">
                    <h5 class="card-title">Communications</h5>
                    <p class="display-4">{{ total_communications }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Gestion des publications -->
          <div class="row g-3 justify-content-center mb-4">
            <div class="col-md-3">
              <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                  <i class="fas fa-list-alt fa-3x text-primary mb-3"></i>
                  <h5 class="card-title">Liste des publications</h5>
                  <p class="card-text">Voir, rechercher et filtrer toutes les publications</p>
                  <a href="{% url 'publications:publication_list' %}" class="btn btn-primary">Accéder</a>
                </div>
              </div>
            </div>
            
            <div class="col-md-3">
              <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                  <i class="fas fa-plus-circle fa-3x text-success mb-3"></i>
                  <h5 class="card-title">Ajouter une publication</h5>
                  <p class="card-text">Enregistrer une nouvelle publication</p>
                  <a href="{% url 'publications:publication_add' %}" class="btn btn-primary">Accéder</a>
                </div>
              </div>
            </div>
            
            <div class="col-md-3">
              <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                  <i class="fas fa-user-graduate fa-3x text-info mb-3"></i>
                  <h5 class="card-title">Publications par enseignant</h5>
                  <p class="card-text">Voir les publications par enseignant</p>
                  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#teacherModal">
                    Sélectionner
                  </button>
                </div>
              </div>
            </div>
            
            <div class="col-md-3">
              <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                  <i class="fas fa-chart-bar fa-3x text-danger mb-3"></i>
                  <h5 class="card-title">Statistiques</h5>
                  <p class="card-text">Statistiques et analyses des publications</p>
                  <a href="{% url 'publications:statistics' %}" class="btn btn-primary">Accéder</a>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Publications récentes -->
          <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Publications récentes</h5>
              <a href="{% url 'publications:publication_list' %}" class="btn btn-sm btn-outline-primary">Voir tout</a>
            </div>
            <div class="card-body">
              {% if recent_publications %}
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Type</th>
                        <th>Titre</th>
                        <th>Date</th>
                        <th>Auteurs</th>
                        <th>Département</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for pub in recent_publications %}
                        <tr>
                          <td>
                            <span class="badge {% if pub.type == 'article' %}bg-info{% elif pub.type == 'livre' %}bg-success{% elif pub.type in 'these,memoire' %}bg-danger{% elif pub.type == 'communication' %}bg-warning{% else %}bg-secondary{% endif %}">
                              {{ pub.get_type_display }}
                            </span>
                          </td>
                          <td><a href="{% url 'publications:publication_detail' pub.id %}">{{ pub.titre }}</a></td>
                          <td>{{ pub.date_publication|date:"d/m/Y" }}</td>
                          <td>
                            {% for auteur in pub.auteurs.all|slice:":2" %}
                              {{ auteur.nom_complet }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                            {% if pub.auteurs.count > 2 %}
                              et {{ pub.auteurs.count|add:"-2" }} autres
                            {% endif %}
                          </td>
                          <td>{% if pub.departement %}{{ pub.departement }}{% else %}-{% endif %}</td>
                          <td>
                            <div class="btn-group btn-group-sm">
                              <a href="{% url 'publications:publication_detail' pub.id %}" class="btn btn-outline-primary" title="Détails">
                                <i class="fas fa-eye"></i>
                              </a>
                              <a href="{% url 'publications:publication_edit' pub.id %}" class="btn btn-outline-warning" title="Modifier">
                                <i class="fas fa-edit"></i>
                              </a>
                            </div>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="alert alert-info">
                  Aucune publication n'a été enregistrée.
                </div>
              {% endif %}
            </div>
          </div>
          
          <!-- Statistiques par département -->
          <div class="row">
            <div class="col-md-6 mb-4">
              <div class="card h-100">
                <div class="card-header bg-light">
                  <h5 class="mb-0">Publications par département</h5>
                </div>
                <div class="card-body">
                  {% if dept_stats %}
                    <div class="table-responsive">
                      <table class="table table-sm">
                        <thead>
                          <tr>
                            <th>Département</th>
                            <th class="text-end">Publications</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for dept in dept_stats %}
                            <tr>
                              <td><a href="{% url 'publications:departement_publications' dept.id %}">{{ dept.nom }}</a></td>
                              <td class="text-end">{{ dept.pub_count }}</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <p class="text-muted">Pas de données disponibles.</p>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <!-- Statistiques par enseignant -->
            <div class="col-md-6 mb-4">
              <div class="card h-100">
                <div class="card-header bg-light">
                  <h5 class="mb-0">Enseignants avec le plus de publications</h5>
                </div>
                <div class="card-body">
                  {% if teacher_stats %}
                    <div class="table-responsive">
                      <table class="table table-sm">
                        <thead>
                          <tr>
                            <th>Enseignant</th>
                            <th class="text-end">Publications</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for teacher in teacher_stats %}
                            <tr>
                              <td><a href="{% url 'publications:teacher_publications' teacher.id %}">{{ teacher.nom_complet }}</a></td>
                              <td class="text-end">{{ teacher.pub_count }}</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <p class="text-muted">Pas de données disponibles.</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-3">
            <a href="{% url 'gestion_administrative:dashboard' %}" class="btn btn-secondary">
              <i class="fas fa-arrow-left"></i> Retour au tableau de bord administratif
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Sélection Enseignant -->
<div class="modal fade" id="teacherModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Sélectionner un enseignant</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <input type="text" id="teacherSearch" class="form-control" placeholder="Rechercher un enseignant...">
        </div>
        <div id="teacherList" class="list-group">
          {% for teacher in teacher_stats %}
            <a href="{% url 'publications:teacher_publications' teacher.id %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
              {{ teacher.nom_complet }}
              <span class="badge bg-primary rounded-pill">{{ teacher.pub_count }}</span>
            </a>
          {% endfor %}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('teacherSearch');
    const teacherList = document.getElementById('teacherList');
    const teachers = teacherList.querySelectorAll('a');
    
    searchInput.addEventListener('keyup', function() {
      const searchValue = this.value.toLowerCase();
      
      teachers.forEach(function(teacher) {
        const teacherName = teacher.textContent.trim().toLowerCase();
        if (teacherName.includes(searchValue)) {
          teacher.style.display = '';
        } else {
          teacher.style.display = 'none';
        }
      });
    });
  });
</script>
{% endblock %}
